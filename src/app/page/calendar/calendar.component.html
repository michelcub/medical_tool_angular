<section class="container-fluid p-4">
  <div class="row d-flex align-items-center border-bottom p-2">
    <button class="btn btn-outline-secondary col-1" (click)="citasService.resetToCurrentWeek()">Esta semana</button>
    <div class="col-1">
      <button (click)="citasService.goToPreviousWeek()"  class="btn col"><i class="fa-solid fa-chevron-left"></i></button>
      <button (click)="citasService.goToNextWeek()" class="btn col-2"><i class="fa-solid fa-chevron-right"></i></button>
    </div>
    <div class="col">
      Week {{ citasService.daysInWeek[0] }} to {{ citasService.daysInWeek[6] }}, {{citasService.monthName}}, {{citasService.year}}
    </div>
    
  </div>

  <div class="row text-center px-5 m-0 overflow-y-auto calendar-container mt-3 position-relative">
    @for(dayInWeek of citasService.daysInWeek; track $index){
      <div class="col m-0 p-0 ">
        <div class="mb-4 position-sticky sticky-top bg-white title-day-calendar">
          @if (citasService.toDay == dayInWeek) {
            <h4 class="bg-primary text-white rounded-pill">{{dayInWeek}}</h4>
          }@else {
            <h4 class="text-secondary">{{dayInWeek}}</h4>
          }
        </div>
        <div class="position-relative">
          @for (hour of citasService.hoursOpen; track $index) {
          
            <div class="border box-calendar position-relative box-component d-flex flex-column"  (dblclick)="showModalCreateCita()">
              @if(dayInWeek.toString().includes("Sunday")){
                <span class="position-absolute  text-primary hora-absolute">{{hour}}</span>
              }
              @for(minute of citasService.minutesOpen; track minute){
                <div class="row  h-50 w-100 ms-0 dragable p-1 m-0" (click)="citasService.selectDay($event)" id="{{citasService.weeksOfYear[citasService.daysInWeek.indexOf(dayInWeek)].split('/').join('-')}}" [attr.time]="hour.split(':')[0] + ':' + minute">
                  <!-- AGREGAMOS CITA SI EXISTA EN ESA HORA -->
                  @for(cita of citasService.citasSemana; track $index){
                    @if(cita.fecha == citasService.weeksOfYear[citasService.daysInWeek.indexOf(dayInWeek)].split('/').join('-') && cita.hora == hour.split(':')[0] + ':' + minute){
                      <button class="col  shadow cita m-0 " type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasRight" aria-controls="offcanvasRight">
                        <div class="d-flex gap-2">
                          <p class="text-secondary p-hora">{{cita?.hora}}</p>
                          <p class="m-0">{{cita?.paciente?.nombre}} {{cita?.paciente?.apellidos}}</p>
                        </div>
                        <p class="m-0">{{cita.motivo}}</p>
                      </button>
                    }
                  }
                </div>
              }
            </div>
          
          }
        </div>
      </div>
    }
    
  </div>
</section>




<!-- Modal -->
<div class="position-absolute create-cita mt-5 card z-5 p-4 shadow" [ngClass]="show_create_cita" >
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h1 class="modal-title fs-5" id="staticBackdropLabel">Crear cita</h1>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" (click)="hideModalCreateCita()"></button>
      </div>
      <div class="modal-body ">
        <p>Seleccionado: {{citasService.selectedDay.date?.split('/').join('-')}}  Hora: {{citasService.selectedDay.time}} </p>
        
        <div class="row d-flex align-items-center p-2">
          <label for="pacientesList" class="form-label col-6">
            Paciente
          <input class="form-control" list="datalistPacientes" id="pacientesList" placeholder="Type to search..." (input)="citasService.handleFindPaciente($event)" (change)="citasService.selectPacienteList($event)">
            
          </label>
          <datalist id="datalistPacientes">
            @for(paciente of citasService.pacienteList; track $index){
              <option value="{{paciente._id}}">{{paciente.nombre}} {{paciente.apellidos}} - Telefono: {{paciente.telefono}}</option>
            }
          </datalist>
          <div class="col mt-3">
            <a href="pacientes/new/" target="_blank" rel="noopener noreferrer" class="border-0"><i class="fa-solid fa-user-plus" ></i> Crear nuevo paciente</a>
          </div>
        </div>

        <div class="row p-2">
          <Label class="col-6">
            Selecciona el dia
            <input type="date" name="date" id="" class="form-control row" value="{{citasService.selectedDay.date.split('/').join('-')}}" (input)="citasService.handleInputNewCita($event)">
          </Label>
          <Label class="col">
            Hora
            <input type="time" class="form-control" value="{{citasService.selectedDay?.time}}" (input)="citasService.handleInputNewCita($event)">
            
          </Label>
          
          
        </div>

        <div class="p-2 row">
          <textarea name="motivo" id="" cols="30" rows="5" class="form-control" placeholder="Motivo de la visita..." (input)="citasService.handleInputNewCita($event)"></textarea>
        </div>

        

      </div>
      <div class="modal-footer d-flex gap-2">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" (click)="hideModalCreateCita()">Close</button>
        <button type="button" class="btn btn-primary {{citasService.showModal}}"  (click)="citasService.saveCita();hideModalCreateCita()">Crear Cita</button>
      </div>
    </div>
  </div>
</div>




<div class="offcanvas offcanvas-end" tabindex="-1" id="offcanvasRight" aria-labelledby="offcanvasRightLabel">
  <div class="offcanvas-header">
    <h5 class="offcanvas-title" id="offcanvasRightLabel">Offcanvas right</h5>
    <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
  </div>
  <div class="offcanvas-body">
    ...
  </div>
</div>